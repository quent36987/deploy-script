---
#- name: Clone Store repository
#  ansible.builtin.git:
#    repo: 'git@github.com:quent36987/cybermaniac-store.git'
#    dest: /repo/cybermaniac-store
#    clone: yes
#    update: yes
#    accept_hostkey: yes
#    key_file: /root/.ssh/id_ed25519
#
#- name: Build Store image
#  community.docker.docker_image:
#    name: store-image:latest
#    force_source: yes
#    build:
#      path: ./repo/cybermaniac-store
#      dockerfile: Dockerfile-ansible
#      args:
#        GATSBY_TELEMETRY_DISABLED: "1"
#        GATSBY_STORE_URL: "https://admin.cybermaniacouioi"
#    source: build
#
- name: Clone Site Web repository
  ansible.builtin.git:
    repo: 'git@github.com:quent36987/cybermaniac-site-web.git'
    dest: /repo/cybermaniac-site-web
    clone: yes
    update: yes
    accept_hostkey: yes
    key_file: /home/quentin/.ssh/id_ed25519

- name: Build Site Web image
  community.docker.docker_image:
    name: site-web-image:latest
    force_source: yes
    build:
      dockerfile: Dockerfile-ansible
      path: /repo/cybermaniac-site-web
      args:
        PUBLIC_STORE_URL: "https://boutique.cybermaniacfr"
    source: build

- name: Save Docker image to tar file
  community.docker.docker_image:
      name: site-web-image:latest
      source: local
      archive_path: /repo/cybermaniac-site-web/site-web-image_latest.tar
#
#- name: Clone Backend repository
#  ansible.builtin.git:
#    repo: 'git@github.com:quent36987/cybermaniac-backend.git'
#    dest: ./repo/cybermaniac-backend
#    clone: yes
#    update: yes
#    accept_hostkey: yes
#    key_file: /home/quentin/.ssh/id_ed25519
#
#- name: Build Backend image
#  community.docker.docker_image:
#    name: cybermaniac-backend-image:latest
#    force_source: yes
#    build:
#      dockerfile: Dockerfile-ansible
#      path: ./repo/cybermaniac-backend
#    source: build

#
- name: Start Docker containers using docker-compose
  community.docker.docker_compose:
      project_src: /files/
      state: present
      restarted: yes
