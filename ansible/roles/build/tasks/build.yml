---
- name: Clone repositories
  ansible.builtin.git:
    repo: '{{ item.repo.url }}'
    dest: '{{ item.repo.dest }}'
    clone: yes
    update: yes
    accept_hostkey: yes
    key_file: '{{ item.repo.key_file }}'
  loop: '{{ services }}'
  loop_control:
    loop_var: item
  when: item.repo is defined

- name: Load seed-bdd
  ansible.builtin.command:
    cmd: cp -r /tmp/seed-bdd /files/postgres/

- name: Build Docker images
  community.docker.docker_image:
    name: '{{ item.image.name }}:latest'
    force_source: yes
    build:
      path: '{{ item.image.path }}'
      dockerfile: '{{ item.image.dockerfile | default("Dockerfile") }}'
      args: "{{ item.image.args | default({}) | to_json }}"
    source: build
  async: 600
  poll: 0
  loop: '{{ services }}'
  loop_control:
    loop_var: item
  register: async_results

- name: Check sync status
  async_status:
    jid: "{{ async_result_item.ansible_job_id }}"
  loop: "{{ async_results.results }}"
  loop_control:
    loop_var: "async_result_item"
  register: async_poll_results
  until: async_poll_results.finished
  retries: 15

- name: Save Docker image to tar file
  community.docker.docker_image:
    name: '{{ item.image.name }}:latest'
    source: local
    archive_path: '{{ item.image.archive_path }}'
  async: 300
  poll: 0
  loop: '{{ services }}'
  loop_control:
    loop_var: item
  register: async_results

- name: Check sync status
  async_status:
    jid: "{{ async_result_item.ansible_job_id }}"
  loop: "{{ async_results.results }}"
  loop_control:
    loop_var: "async_result_item"
  register: async_poll_results
  until: async_poll_results.finished
  retries: 15

- name: Create Services Template
  ansible.builtin.template:
    src: templates/services.j2
    dest: /files/services.txt




